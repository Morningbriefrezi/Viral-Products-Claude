name: ğŸŒ World Viral Product Hunter

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if already ran today'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  MAX_DAYS: 15
  PRODUCTS_PER_DAY: 10

jobs:
  hunt-products:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install
        run: npm install --no-package-lock

      - name: ğŸ“‚ Restore data
        run: |
          if [ -f data/history.json ]; then cp data/history.json history.json; else echo '{"products":[]}' > history.json; fi
          if [ -f data/state.json ]; then cp data/state.json state.json; else echo '{"currentDay":0,"lastRunDate":null}' > state.json; fi
          if [ -f data/trends.json ]; then cp data/trends.json trends.json; else echo '{"tracked":{}}' > trends.json; fi

      - name: ğŸ”„ Force run override
        if: ${{ github.event.inputs.force_run == 'true' }}
        run: |
          node -e "const fs=require('fs');const s=JSON.parse(fs.readFileSync('state.json','utf-8'));s.lastRunDate=null;fs.writeFileSync('state.json',JSON.stringify(s,null,2));"

      - name: ğŸš€ Run
        run: node run-once.js

      - name: ğŸ’¾ Save data
        run: |
          mkdir -p data
          cp history.json data/history.json
          cp state.json data/state.json
          cp trends.json data/trends.json
          git config user.name "Bot"
          git config user.email "bot@github-actions"
          git add data/
          if git diff --cached --quiet; then echo "No changes"; else git commit -m "ğŸ¤– Product hunt $(date -u +%Y-%m-%d)" && git push; fi

      - name: ğŸ Status
        run: node -e "const s=JSON.parse(require('fs').readFileSync('state.json','utf-8'));console.log('Day '+s.currentDay+'/15');"
