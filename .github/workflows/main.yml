name: ğŸŒ World Viral Product Hunter

on:
  schedule:
    - cron: '0 5 * * *'

  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if already ran today'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  MAX_DAYS: 15
  PRODUCTS_PER_DAY: 10

jobs:
  hunt-products:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“‚ Find project root
        id: find
        run: |
          echo "ğŸ“ Repo contents:"
          ls -la
          echo ""
          PROJECT_DIR=$(dirname $(find . -name "package.json" -not -path "*/node_modules/*" | head -1))
          echo "ğŸ“ Project found at: $PROJECT_DIR"
          echo "dir=$PROJECT_DIR" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Install dependencies
        run: cd ${{ steps.find.outputs.dir }} && npm install --no-package-lock

      - name: ğŸ“‚ Restore data files
        run: |
          cd ${{ steps.find.outputs.dir }}
          if [ -f data/history.json ]; then
            cp data/history.json history.json
            echo "âœ… Restored history.json"
          else
            echo '{"products":[]}' > history.json
            echo "ğŸ†• Created fresh history.json"
          fi

          if [ -f data/state.json ]; then
            cp data/state.json state.json
            echo "âœ… Restored state.json"
          else
            echo '{"currentDay":0,"lastRunDate":null}' > state.json
            echo "ğŸ†• Created fresh state.json"
          fi

      - name: ğŸ”„ Force run override
        if: ${{ github.event.inputs.force_run == 'true' }}
        run: |
          cd ${{ steps.find.outputs.dir }}
          node -e "
            const fs = require('fs');
            const state = JSON.parse(fs.readFileSync('state.json','utf-8'));
            state.lastRunDate = null;
            fs.writeFileSync('state.json', JSON.stringify(state, null, 2));
            console.log('âœ… Force run: reset lastRunDate');
          "

      - name: ğŸš€ Run Viral Product Hunter
        run: cd ${{ steps.find.outputs.dir }} && node src/run-once.js

      - name: ğŸ’¾ Save data to repo
        run: |
          cd ${{ steps.find.outputs.dir }}
          mkdir -p data
          cp history.json data/history.json
          cp state.json data/state.json

          cd $GITHUB_WORKSPACE
          git config user.name "Viral Product Hunter Bot"
          git config user.email "bot@github-actions"
          git add -A

          if git diff --cached --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            CURRENT_DAY=$(cd ${{ steps.find.outputs.dir }} && node -e "const s=JSON.parse(require('fs').readFileSync('state.json','utf-8'));console.log(s.currentDay)")
            git commit -m "ğŸ¤– Day ${CURRENT_DAY} â€” $(date -u +%Y-%m-%d) product hunt complete"
            git push
            echo "âœ… Data pushed"
          fi

      - name: ğŸ Check completion
        run: |
          cd ${{ steps.find.outputs.dir }}
          node -e "
            const s = JSON.parse(require('fs').readFileSync('state.json','utf-8'));
            console.log('ğŸ“Š Day ' + s.currentDay + '/15');
            if (s.currentDay >= 15) console.log('ğŸ All 15 days completed!');
            else console.log('â° Next run: tomorrow at 05:00 UTC');
          "
